(()=>{"use strict";window.util={isEnterEvent:function(e,n){"Enter"===e.key&&n()},isEscEvent:function(e,n){"Escape"===e.key&&n()},sliceArr:function(e,n){return e.length>n?e.slice(0,n):e}},function(){let e=document.querySelector("main"),n=document.querySelector("#address"),t=document.querySelector("#type"),o=document.querySelector("#price"),i=document.querySelector("#room_number"),r=document.querySelector("#capacity");window.addForm=document.querySelector(".ad-form"),window.formResetButton=document.querySelector(".ad-form__reset");let d=document.querySelector("#timein"),a=document.querySelector("#timeout");window.returnDefaultPage=function(){window.map.disableMap(),window.form.disableForm(window.fieldsets),window.form.disableForm(window.selects),window.pins.removePins(),window.addForm.reset(),window.mainPinResetPosition()};let u=function(){let n=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.appendChild(n);let t=document.querySelector(".error__button"),o=document.querySelector(".error"),i=function(){e.removeChild(o)};t.addEventListener("click",(function(){i()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&i()})),document.addEventListener("click",(function(){i()}))},l=function(){window.returnDefaultPage();let n=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.appendChild(n);let t=e.querySelector(".success"),o=function(){e.removeChild(t)};document.addEventListener("click",(function(){o()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&o()}))};window.addForm.addEventListener("submit",(function(e){e.preventDefault(),window.upload(new FormData(window.addForm),l,u)})),window.addForm.addEventListener("change",(function(){var e,n;"flat"===t.value?(o.min=1e3,o.placeholder=1e3):"bungalow"===t.value?(o.min=0,o.placeholder=0):"house"===t.value?(o.min=5e3,o.placeholder=5e3):"palace"===t.value&&(o.min=1e4,o.placeholder=1e4),n=a,"12:00"===(e=d).value?n.value="12:00":"13:00"===e.value?n.value="13:00":"14:00"===e.value&&(n.value="14:00")})),window.form={validateGuestForm:function(){1===Number(i.value)&&1!==Number(r.value)?i.setCustomValidity("1 комната только для одного гостя"):2===Number(i.value)&&Number(r.value)>2?i.setCustomValidity("2 комната только для одного или 2 гостей"):2===Number(i.value)&&0===Number(r.value)?i.setCustomValidity("2 комнаты только для одного или двух гостей"):3===Number(i.value)&&Number(r.value)<1?i.setCustomValidity("3 комнаты только для одного , двух или трех гостей"):100===Number(i.value)&&0!==Number(r.value)?i.setCustomValidity("100 комнат не для гостей"):i.setCustomValidity("")},fillAddressFieldDisabled:function(){n.value=Math.round(window.mainPin.offsetTop+window.mainPin.offsetHeight/2)+","+Math.round(window.mainPin.offsetLeft+window.mainPin.offsetWidth/2)},disableForm:function(e){for(let n=0;n<=e.length-1;n++)e[n].disabled=!0},activateForm:function(e){for(let n=0;n<=e.length-1;n++)e[n].disabled=!1},fillAddressFieldActive:function(){let e=Math.round(window.mainPin.offsetTop+window.mainPinStartY),t=Math.round(window.mainPin.offsetLeft+window.mainPinStartX);n.value=e+","+t}}}(),window.upload=function(e,n,t){let o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?n():t()})),o.addEventListener("error",(function(){t()})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},window.load=function(e,n){let t=new XMLHttpRequest;t.responseType="json",t.addEventListener("load",(function(){200===t.status?e(t.response):n("Статус ответа: "+t.status+" "+t.statusText)})),t.addEventListener("error",(function(){n("Произошла ошибка соединения")})),t.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+t.timeout+" мс")})),t.timeout=1e4,t.open("GET","https://21.javascript.pages.academy/keksobooking/data"),t.send()},function(){window.mainPin=document.querySelector(".map__pin--main"),window.serverData=[];let e=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.querySelector(".map__pins");window.mainPinStartY=Math.round(window.mainPin.offsetHeight+22),window.mainPinStartX=Math.round(window.mainPin.offsetWidth/2),window.mainPinResetPosition=function(){window.mainPin.style.left="570px",window.mainPin.style.top="375px"},window.pins={removePins:function(){let e=document.querySelectorAll(".map__pin");for(let t=e.length-1;t>=1;t--)n.removeChild(e[t])}},window.drawPins=function(t){let o=function(e){return e.length>5?e.slice(0,5):e}(t);for(let t=0;t<o.length;t++){let i=e.cloneNode(!0);i.querySelector("img").src=o[t].author.avatar,i.querySelector("img").alt=o[t].author.title,i.style.left=o[t].location.x+"px",i.style.top=o[t].location.y+"px",n.appendChild(i)}},window.successHandler=function(e){window.serverData=e,window.drawPins(e),window.filtredData=window.serverData,window.filtredPins=window.filtredData},window.errorHandler=function(e){let n=document.createElement("div");n.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",n.style.position="absolute",n.style.left=0,n.style.right=0,n.style.fontSize="30px",n.textContent=e,document.body.insertAdjacentElement("afterbegin",n)},n.addEventListener("click",(function(e){let n=document.querySelectorAll(".map__pin"),t=document.querySelectorAll(".map__pin img");for(let o=1;o<=n.length;o++)n[o]!==e.target&&t[o]!==e.target||window.drawCard(window.filtredPins[o-1])}))}(),function(){let e=document.querySelector(".map__filters"),n=document.querySelector("#housing-type"),t=document.querySelector("#housing-price"),o=document.querySelector("#housing-rooms"),i=document.querySelector("#housing-guests"),r=document.querySelectorAll("#housing-features input"),d=function(){let e=document.querySelector(".popup");window.mainMap.contains(e)&&window.pinCards.closePinCard(),window.pins.removePins(),window.filtredPins=window.serverData,function(e){if("any"!==n.value){let t=e.filter((function(e){return e.offer.type===n.value}));window.filtredPins=t}}(window.filtredPins),function(e){if("any"!==t.value){let n=e.filter((function(e){let n;return e.offer.price<1e4?n="low":e.offer.price>1e4&&e.offer.price<5e4?n="middle":e.offer.price>=5e4&&(n="high"),n===t.value}));window.filtredPins=n}}(window.filtredPins),function(e){if("any"!==o.value){let n=e.filter((function(e){return e.offer.rooms+""===o.value}));window.filtredPins=n}}(window.filtredPins),function(e){if("any"!==i.value){let n=e.filter((function(e){return e.offer.guests+""===i.value}));window.filtredPins=n}}(window.filtredPins),function(){for(let e=0;e<r.length;e++)if(r[e].checked){let n=window.filtredPins.filter((function(n){return n.offer.features[e]===r[e].value}));window.filtredPins=n}}(window.filtredPins),window.drawPins(window.filtredPins)};e.addEventListener("change",(function(){window.debounce(d)}))}(),function(){let e;window.debounce=function(n){e&&window.clearTimeout(e),e=setTimeout(n,300)}}(),function(){let e=document.querySelector(".map__filters-container");window.mainMap=document.querySelector(".map");let n=document.querySelector("#card").content.querySelector(".map__card");window.drawCard=function(o){let i=document.createDocumentFragment();i.appendChild(function(e){let t=n.cloneNode(!0);return t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+" / ночь",t.querySelector(".popup__type").textContent=e.offer.type,t.querySelector(".popup__text--capacity").textContent=e.offer.rooms+" комнат для "+e.offer.guests+" гостей",t.querySelector(".popup__text--time").textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout,function(){t.querySelector(".popup__features").innerHTML="";for(let n=0;n<=e.offer.features.length-1;n++){let o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+e.offer.features[n]),t.querySelector(".popup__features").appendChild(o)}}(),t.querySelector(".popup__description").textContent=e.offer.description,function(){t.querySelector(".popup__photo").src=e.offer.photos[0];for(let n=1;n<e.offer.photos.length;n++){let o=t.querySelector(".popup__photo").cloneNode(!0);o.src=e.offer.photos[n],t.querySelector(".popup__photos").appendChild(o)}}(),t.querySelector(".popup__avatar").src=e.author.avatar,t}(o)),window.pinCard=document.querySelector(".popup"),window.mainMap.contains(window.pinCard)?(window.mainMap.removeChild(window.pinCard),window.mainMap.insertBefore(i,e)):window.mainMap.insertBefore(i,e),document.querySelector(".popup__close").addEventListener("click",(function(){t()})),window.addEventListener("keydown",(function(e){"Escape"===e.key&&t()}))};let t=function(){let e=document.querySelector(".popup");window.mainMap.contains(e)&&(window.mainMap.removeChild(e),document.removeEventListener("keydown",o))},o=function(e){"Escape"===e.key&&t()};window.pinCards={closePinCard:t}}(),function(){window.mainMap=document.querySelector(".map"),window.mainPin=document.querySelector(".map__pin--main");let e=document.querySelector(".ad-form"),n=function(e){window.util.isEnterEvent(e,window.map.activateMap)};window.map={activateMap:function(){window.mainMap.classList.remove("map--faded"),e.classList.remove("ad-form--disabled"),window.mainPin.removeEventListener("keydown",n)},disableMap:function(){window.mainMap.classList.add("map--faded"),e.classList.add("ad-form--disabled")}}}(),(()=>{let e=document.querySelector(".ad-form");window.fieldsets=document.querySelectorAll("fieldset"),window.selects=document.querySelectorAll("select"),window.form.fillAddressFieldDisabled(),window.form.disableForm(window.fieldsets),window.form.disableForm(window.selects),e.addEventListener("input",(function(){window.form.validateGuestForm()}));let n=function(e){1===e.which&&(window.map.activateMap(),window.form.activateForm(window.fieldsets),window.form.activateForm(window.selects),window.form.fillAddressFieldActive(),window.load(window.successHandler,window.errorHandler),window.formResetButton.addEventListener("click",(function(){window.pinCards.closePinCard(),window.returnDefaultPage(),window.mainPin.addEventListener("mousedown",n)})),window.mainPin.removeEventListener("mousedown",n))};window.mainPin.addEventListener("mousedown",n)})(),function(){let e=0-window.mainPinStartX,n=window.mainMap.offsetWidth-window.mainPinStartX;window.mainPin.addEventListener("keydown",(function(e){window.util.isEnterEvent(e,(function(){window.load(window.successHandler,window.errorHandler),window.map.activateMap()}))})),window.mainPin.addEventListener("mousedown",(function(t){t.preventDefault();var o={x:t.clientX,y:t.clientY},i=function(t){var i=o.x-t.clientX,r=o.y-t.clientY;o={x:t.clientX,y:t.clientY},window.mainPin.style.top=window.mainPin.offsetTop-r+"px",window.mainPin.style.left=window.mainPin.offsetLeft-i+"px",window.mainPin.offsetLeft<e?window.mainPin.style.left=window.mainPin.offsetLeft+i+"px":window.mainPin.offsetLeft>=n&&(window.mainPin.style.left=window.mainMap.offsetWidth-window.mainPin.offsetWidth/2-i+"px"),(window.mainPin.offsetTop<=130||window.mainPin.offsetTop>630)&&(window.mainPin.style.top=window.mainPin.offsetTop+r+"px"),window.form.fillAddressFieldActive()},r=function(e){e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",r)}))}()})();